<script type="text/javascript">

var activeTabId = null;

function updateIcon( newState ) {
	var iconPath = newState ? "img/enabled.png" : "img/disabled.png";
	chrome.browserAction.setIcon({path: iconPath});
}

function updateIconFromResponse( response ) {
	updateIcon(response.enabled);
}

chrome.browserAction.onClicked.addListener(function(tab){
    chrome.tabs.sendMessage(activeTabId, {type: 'toggle'}, updateIconFromResponse);
});

chrome.tabs.onActivated.addListener( function( activeInfo ) {
	activeTabId = activeInfo.tabId;
	chrome.tabs.sendMessage(activeTabId, {type: 'getEnabled'}, updateIconFromResponse);
});

chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
	if (changeInfo.status === 'loading' && tabId === activeTabId) {
		chrome.tabs.sendMessage(activeTabId, {type: 'getEnabled'}, updateIconFromResponse);
	}
});

</script>

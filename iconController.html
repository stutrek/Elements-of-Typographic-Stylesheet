<script type="text/javascript">
var activeTabId = null;
var HOST_REGEX = /https?:\/\/([^\/]+)*/

function getEnabled( event ) {
	var host = HOST_REGEX.exec(event.target.browserWindow.activeTab.url)[1];
	
	if (localStorage[host] === "off") {
		return false;
	} else {
		return true;
	}
}
function setImage( event ) {
	var imagePathArray = event.target.image.split('/');
	imagePathArray.pop();
	
	if ( getEnabled( event ) ) {
		imagePathArray.push('enabled.png');
	} else {
		imagePathArray.push('disabled.png');
	}
	
	event.target.image = imagePathArray.join('/');

}
function enableOrDisable( event ) {
	if (getEnabled(event)) {
		event.target.browserWindow.activeTab.page.dispatchMessage('enable');
		//chrome.tabs.sendMessage(tab.id, {type: 'enable', url: tab.url});
		//event.target.disabled = false;
	} else {
		event.target.browserWindow.activeTab.page.dispatchMessage('disable');
		//chrome.tabs.sendMessage(tab.id, {type: 'disable', url: tab.url});
		//event.target.disabled = true;
	}
	setImage( event );
}

safari.application.addEventListener( "command", function( event ){
	if (event.command === "toggle_eotss") {
		console.log(event);
		var host = HOST_REGEX.exec(event.target.browserWindow.activeTab.url)[1];
		
		if (getEnabled(event)) {
			localStorage[host] = "off";
		} else {
			delete localStorage[host];
		}
		
		enableOrDisable( event );
	}
}, false);

safari.application.addEventListener("validate", enableOrDisable, false);
/*
chrome.tabs.onActivated.addListener( function( activeInfo ) {
	activeTabId = activeInfo.tabId || activeInfo.tabIds[0];
	chrome.tabs.get( activeTabId, function(tab) {
		if ( tab.url.substring(0, 4) !== 'http') {
			chrome.pageAction.hide(tab.id);
			return;
		}
		enableOrDisableTab( tab );
	})
});

chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
	enableOrDisableTab( tab );
});
*/
</script>
